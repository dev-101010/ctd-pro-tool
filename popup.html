<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>C-TD Upgrade Tool</title>
    <script src="https://www.c-td.de/assets/custom/socket.io.js"></script>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
            background-color: #121212;
            color: white;
        }

        .map-info-bar {
            background-color: #1a1a1a;
            color: #ccc;
            padding: 8px 16px;
            font-size: 14px;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
        }
        .info-block {
            min-width: 120px;
        }

        .tab-menu {
            display: flex;
            background-color: #222;
        }

        .tab-menu button {
            flex: 1;
            padding: 12px;
            background-color: #333;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .tab-menu button:hover,
        .tab-menu button.active {
            background-color: #444;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;

        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select, button {
            background-color: #333;
            color: white;
            border: 1px solid #555;
            padding: 5px 10px;
            cursor: pointer;
        }

        .skill-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /*noinspection CssUnusedSymbol*/
        .skill-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /*noinspection CssUnusedSymbol*/
        .skill-name {
            width: 100px;
        }

        /*noinspection CssUnusedSymbol*/
        .skill-boxes {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
        }

        /*noinspection CssUnusedSymbol*/
        .box {
            width: 12px;
            height: 12px;
            background-color: #444;
            border: 1px solid #666;
            cursor: pointer;
            user-select: none;
        }

        /*noinspection CssUnusedSymbol*/
        .box.active {
            background-color: limegreen;
        }

        #loadingMessage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-family: sans-serif;
            z-index: 9999;
        }

        #toggleStartStop {
            border-radius: 6px;
        }

        #toggleStartStop:hover {
            scale: 1.2;
        }

        #toggleStartStop:active {
            scale: 0.8;
        }

        #toggleStartStop:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(50%);
        }

        .profileButton {
            border-radius: 6px;
        }

        .profileButton:hover {
            scale: 1.2;
        }

        .profileButton:active {
            scale: 0.8;
        }

        .profileButton:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(50%);
        }

        #toastContainer {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        /*noinspection CssUnusedSymbol*/
        .toast {
            background-color: #222;
            color: #ccc;
            font-size: 13px;
            padding: 6px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            min-width: 160px;
            max-width: 240px;
            opacity: 0;
            transform: translateX(100%);
            animation: toast-in 0.2s ease-out forwards;
            pointer-events: auto;
        }

        /*noinspection CssUnusedSymbol*/
        .toast.success {
            border-left: 3px solid limegreen;
        }

        /*noinspection CssUnusedSymbol*/
        .toast.error {
            border-left: 3px solid crimson;
        }

        /*noinspection CssUnusedSymbol*/
        .toast.info {
            border-left: 3px solid dodgerblue;
        }

        @keyframes toast-in {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toast-out {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
    </style>
</head>
<body>

<div id="loadingMessage">
    <p>Lade Daten, bitte warten...</p>
</div>

<div id="mainContent" style="display: none;">

    <div id="mapInfoBar" class="map-info-bar">
        <span class="info-block">User: <span id="userName">â€“</span></span>
        <span class="info-block">Map: <span id="mapName">â€“</span></span>
        <span class="info-block">Tower: <span id="towerName">â€“</span></span>
        <span class="info-block">Level: <span id="towerLevel">â€“</span></span>
    </div>

    <div class="tab-menu">
        <button class="tab-button active" onclick="showTab(0)">Upgrade</button>
        <button class="tab-button" onclick="showTab(1)">Tab 2</button>
        <button class="tab-button" onclick="showTab(2)">Tab 3</button>
    </div>

    <div class="tab-content active">
        <div class="header-bar">
            <button id="toggleStartStop" onclick="toggleButtonState()" style="background-color: green;">Start</button>
            <div>Credits: <span id="openCredits">0</span>/<span id="neededCredits">0</span></div>
            <div class="controls">
                <label for="profileSelect">Profiles</label>
                <select id="profileSelect">
                    <!-- Dynamisch befÃ¼llt -->
                </select>
                <button id="newProfileButton" class="profileButton" onclick="newProfile()">âž•</button>
                <button id="loadProfileButton" class="profileButton" onclick="loadProfile()">ðŸ“‚</button>
                <button id="saveProfileButton" class="profileButton" onclick="saveProfile()">ðŸ’¾</button>
            </div>
        </div>

        <div class="skill-container" id="skillContainer">
            <!-- Dynamisch generierte Skills -->
        </div>
    </div>

    <div class="tab-content">
        <h2>Inhalt Tab 2</h2>
        <p>Hier steht der Inhalt des zweiten Tabs.</p>
    </div>

    <div class="tab-content">
        <h2>Inhalt Tab 3</h2>
        <p>Hier steht der Inhalt des dritten Tabs.</p>
    </div>

</div>

<div id="toastContainer"></div>

<script>

    let socket = null;

    let isMouseDown = false;
    let dragMode = null;

    let userData = {};
    let mapData = {};
    let towerMainValues = {};
    let towerStatsData = {};
    let towerUpgradeData = {};

    let mapCredits = 0;
    let openCredits = 0;
    let neededCredits = 0;

    let skillBuilded = false;
    let isRunning = false;
    let hasMap = false;
    let hasTower = false;

    const skillData = [];

    const loadingMessage = document.getElementById("loadingMessage");
    const mainContent = document.getElementById("mainContent");
    const skillContainer = document.getElementById('skillContainer');
    const openCreditsEl = document.getElementById('openCredits');
    const neededCreditsEl = document.getElementById('neededCredits');

    function showTab(index) {
        const buttons = document.querySelectorAll('.tab-button');
        const contents = document.querySelectorAll('.tab-content');

        buttons.forEach(btn => btn.classList.remove('active'));
        contents.forEach(content => content.classList.remove('active'));

        buttons[index].classList.add('active');
        contents[index].classList.add('active');
    }

    function startSocket(serverURI, userToken, authToken) {
        socket = io(serverURI, {
            reconnection: true,
            reconnectionDelayMax: 1000,
            reconnectionAttempts: 0,
            pingTimeout: 20000,
            pingInterval: 25000,

            auth: {
                authToken: authToken
            }
        });

        window.addEventListener('beforeunload', () => {
            socket.disconnect();
        });

        socket.onAny((event, ...args) => {
            if (event !== "ding" && event !== "dong") {
                console.log(event, args);
            }
        });

        socket.on("connect", () => {
            socket.emit("authUser", {
                token: userToken
            });
            console.log("Connected");
        });

        socket.on("authSuccess", () => {
            socket.emit("setPage", {
                page: "battlefield"
            });
            console.log("Auth success");
            setTimeout(() => {
                loadingMessage.style.display = "none";
                mainContent.style.display = "block";
            }, 500);
        });

        socket.on("updateUserDetails", (data, act) => {
            act();
            userData = data;
        });

        socket.on("mapLoaded", (data, act) => {
            act();
            resetMap();
            mapData = data;
            hasMap = true;
            updateMapInfo();
        });

        socket.on("mapClosed", (data, act) => {
            act();
            resetMap();
        });

        socket.on("mapCreditsChanged", (data, act) => {
            act();
            mapCredits = data.amount;
            updateCredits();
        });

        socket.on("userTowerPlaced", (data, act) => {
            act();
            if (userData.user.uid === data.user.uid) {
                towerMainValues = data.data;
                updateCredits();
                updateMapInfo();
            }
        });

        socket.on("removeTower", (data, act) => {
            act();
            if (userData.user.uid === data.user.uid) {
                resetTower();
            }
        });

        socket.on("towerMainValuesChanged", (data, act) => {
            act();
            if (userData.user.uid === data.user.uid) {
                towerMainValues = data.data;
                updateCredits();
                updateMapInfo();
            }
        });

        socket.on("towerStatsValuesChanged", (data, act) => {
            act();
            if (userData.user.uid === data.user.uid) {
                towerStatsData = data.statsData;
                towerUpgradeData = data.upgradeData;
                if(!skillBuilded) fillSkillContainer();
                hasTower = true;
                setToggleButtonEnabled(true);
                setProfileButtonsEnabled(true);
            }
        });
    }

    function updateCredits() {
        const creditsUsed = towerMainValues.creditsUsed ?? 0;
        openCredits = mapCredits - creditsUsed;
        openCreditsEl.innerHTML = `${openCredits}`;
        const cost = mapData.map?.towerUpgradeCost ?? 0;
        const multi = towerMainValues.upgradeMulti ?? 1;
        neededCredits = cost * multi;
        neededCreditsEl.innerHTML = `${neededCredits}`;
    }

    function resetTower() {
        //let userData = {}; userdata not change by map change

        towerMainValues = {};
        towerStatsData = [];
        towerUpgradeData = [];

        skillBuilded = false;
        hasTower = false;

        updateCredits();
        clearSkillContainer();
        updateMapInfo();
        setButtonState(false);
        setToggleButtonEnabled(false);
        setProfileButtonsEnabled(false);
    }

    function resetMap() {
        mapData = {};

        mapCredits = 0;
        openCredits = 0;
        neededCredits = 0;

        hasMap = false;

        updateMapInfo();
        resetTower();
    }

    function fillSkillContainer() {
        skillBuilded = true;
        towerUpgradeData.forEach((data, idx) => {
            const name = data.name;
            createSkillRow(name, idx);
        });
    }
    
    function clearSkillContainer() {
        while (skillContainer.firstChild) {
            skillContainer.removeChild(skillContainer.firstChild);
        }
    }

    function createSkillRow(skillName, skillIndex) {
        const row = document.createElement('div');
        row.className = 'skill-row';

        const label = document.createElement('div');
        label.className = 'skill-name';
        label.textContent = skillName;
        row.appendChild(label);

        const boxes = document.createElement('div');
        boxes.className = 'skill-boxes';

        for (let i = 0; i < 100; i++) {
            const box = document.createElement('div');
            box.className = 'box';
            box.setAttribute('draggable', 'false');
            box.dataset.index = i;
            box.dataset.skill = skillIndex;

            box.addEventListener('mousedown', () => {

                const column = Number(box.dataset.index);
                const row = Number(box.dataset.skill);
                const name = towerUpgradeData[row]?.name;

                if (skillData[column] === name) {
                    dragMode = "remove";
                    skillData[column] = null;
                } else {
                    dragMode = "set";
                    skillData[column] = name;
                }

                syncVisualWithSkillData(skillData);
            });

            box.addEventListener('mouseenter', () => {
                if (!isMouseDown || !dragMode) return;

                const column = Number(box.dataset.index);
                const row = Number(box.dataset.skill);
                const name = towerUpgradeData[row]?.name;

                if (dragMode === "set" && skillData[column] !== name) {
                    skillData[column] = name;
                    syncVisualWithSkillData(skillData);
                } else if (dragMode === "remove" && skillData[column] === name) {
                    skillData[column] = null;
                    syncVisualWithSkillData(skillData);
                }
            });

            boxes.appendChild(box);
        }

        row.appendChild(boxes);
        skillContainer.appendChild(row);
    }

    function loadProfiles() {
        const profileSelect = document.getElementById('profileSelect');
        profileSelect.innerHTML = '';

        const profiles = JSON.parse(localStorage.getItem("upgradeProfiles") || "{}");
        Object.keys(profiles).forEach(name => {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            profileSelect.appendChild(option);
        });
    }

    function saveProfile() {
        if(!hasTower) return;
        const profileSelect = document.getElementById("profileSelect");
        const selectedName = profileSelect.value;

        if (!selectedName) {
            showToast("Bitte wÃ¤hle ein Profil aus oder erstelle ein neues.","info");
            return;
        }

        const profiles = JSON.parse(localStorage.getItem("upgradeProfiles") || "{}");
        profiles[selectedName] = skillData;
        localStorage.setItem("upgradeProfiles", JSON.stringify(profiles));

        showToast("Profil gespeichert.","success");
    }

    function loadProfile() {
        if(!hasTower) return;
        const profileSelect = document.getElementById("profileSelect");
        const selectedName = profileSelect.value;

        if (!selectedName) {
            showToast("Bitte wÃ¤hle ein Profil aus.","info");
            return;
        }

        const profiles = JSON.parse(localStorage.getItem("upgradeProfiles") || "{}");
        const profile = profiles[selectedName];

        if (Array.isArray(profile)) {
            for (let i = 0; i < skillData.length; i++) skillData[i] = null;
            profile.forEach((val, i) => {
                skillData[i] = val || null;
            });
            syncVisualWithSkillData(skillData);
            showToast("Profil geladen.","success");
        } else {
            showToast("Fehler beim Laden des Profils.","error");
        }
    }

    function newProfile() {
        const name = prompt("Neuer Profilname:");
        if (!name) return;

        const profileSelect = document.getElementById("profileSelect");
        const profiles = JSON.parse(localStorage.getItem("upgradeProfiles") || "{}");

        if (profiles[name]) {
            showToast("Profilname existiert bereits.","error");
            return;
        }

        profiles[name] = [];
        localStorage.setItem("upgradeProfiles", JSON.stringify(profiles));

        const option = document.createElement('option');
        option.textContent = name;
        option.value = name;
        profileSelect.appendChild(option);
        profileSelect.value = name;

        showToast("Profil erstellt.","success");
    }

    function updateMapInfo() {
        const userName = userData?.user?.displayname;
        const mapName = mapData?.map?.name;
        const towerName = towerMainValues?.name;
        const towerLevel = towerMainValues?.level;
        document.getElementById("userName").textContent = userName ?? "â€“";
        document.getElementById("mapName").textContent = mapName ?? "â€“";
        document.getElementById("towerName").textContent = towerName ?? "â€“";
        document.getElementById("towerLevel").textContent = (towerLevel ?? "â€“");
    }

    function toggleButtonState() {
        isRunning = !isRunning;
        const btn = document.getElementById("toggleStartStop");
        if (isRunning) {
            btn.textContent = "Stop";
            btn.style.backgroundColor = "red";
        } else {
            btn.textContent = "Start";
            btn.style.backgroundColor = "green";
        }

        if(isRunning) startLoop(); else stopLoop();
    }

    function setToggleButtonEnabled(state) {
        const btn = document.getElementById("toggleStartStop");
        btn.disabled = !state;
    }

    function setProfileButtonsEnabled(state) {
        const btn1 = document.getElementById("loadProfileButton");
        const btn2 = document.getElementById("saveProfileButton");
        btn1.disabled = !state;
        btn2.disabled = !state;
    }

    function setButtonState(running) {
        if (isRunning !== running) {
            toggleButtonState();
        }
    }

    function update() {
        if(openCredits <= 0 || neededCredits <= 0 || openCredits < neededCredits ) return;
        const skill = skillData.splice(0,1);
        const name = skill[0];
        if(typeof name === 'string' && name) {
            // noinspection JSUnresolvedReference
            socket.emit('upgradeTower', {name});
        }
        syncVisualWithSkillData(skillData);
    }

    let loopInterval = null;

    function startLoop() {
        if (loopInterval !== null) return;
        loopInterval = setInterval(update, 1000);
    }

    function stopLoop() {
        clearInterval(loopInterval);
        loopInterval = null;
    }

    function syncVisualWithSkillData(skillArray) {
        const allBoxes = document.querySelectorAll('.box');

        allBoxes.forEach(box => {
            const index = Number(box.dataset.index); // Spalte
            const skillIdx = Number(box.dataset.skill); // Zeile
            const expectedSkillName = skillArray[index];

            const actualName = towerUpgradeData?.[skillIdx]?.name;

            if (expectedSkillName && actualName === expectedSkillName) {
                box.classList.add('active');
            } else {
                box.classList.remove('active');
            }
        });
    }

    function showToast(message, type = "info") {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;

        container.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'toast-out 0.3s ease-in forwards';
            toast.addEventListener('animationend', () => toast.remove());
        }, 2000);
    }

    document.addEventListener('mousedown', () => {
        isMouseDown = true;
    });

    document.addEventListener('mouseup', () => {
        isMouseDown = false;
        dragMode = null;
    });

    window.addEventListener("load", () => {

        let authToken = "";
        let userToken = "";
        let domain = "";

        try {
            authToken = window.opener?.sessionStorage.getItem("authToken");
            userToken = window.opener?.sessionStorage.getItem("userToken");
            domain = window.opener?.location.hostname;
        } catch (e) {
            console.error("Zugriff auf Daten fehlgeschlagen!");
            return;
        }

        if (!userToken || !authToken) {
            console.error("Kein Token gefunden!");
            return;
        }

        let serverURI = "";

        switch (domain) {
            case "www.c-td.de":
                serverURI = "wss://ctd.drochmann.de:8125";
                break;
            case "ctddev.shimly-dev.de":
                serverURI = "wss://ctd.drochmann.de:8225";
                break;
        }

        if (!serverURI) {
            console.error("Unbekannte Domain!");
            return;
        }

        loadProfiles();

        startSocket(serverURI, userToken, authToken);

    });
</script>
</body>
</html>